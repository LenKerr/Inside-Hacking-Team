<!DOCTYPE html>
<meta charset="utf-8">
<title>Inside Hacking Team</title>
<style>

@import url(http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700);

</style>

<div id="viz">

  <!-- <a href="https://github.com/square"><img src="logotype.png" width="122" height="31"></a> -->

  

  <div id="tooltip"></div>
  <div id="charts" class="charts-border">
    <div id="hour-chart" class="chart">
      <div class="title">Time of Day</div>
    </div>
    <div id="delay-chart" class="chart">
      <div class="title">Day of Week</div>
    </div>
    <div id="date-chart" class="chart">
      <div class="title">Date</div>
    </div>
  </div>
  <div id="relationship-chart" class="chrod">
    <div class="title">Internal Relationship</div>
  </div>

  <div id="subject-chart" class="wordle">
    <div class="title">Subject Wordle</div>
  </div>

  <aside id="totals"><span id="active">-</span> of <span id="total">-</span> flights selected.</aside>

  <!-- <div id="lists">
    <div id="flight-list" class="list"></div>
  </div> -->

</div>
<div id="body">

  <h1>Inside Hacking Team</h1>

  <h2>Generate new insights from metadata.</h2>
  <p>Hacking Team 是一家来自意大利米兰的信息技术公司，2015 年 7 月 5 日， Hacking Team 公司的官方 Twitter 帐号遭到不明人士入侵，随后，其公布了内部电子邮件等。Hacking Team 公司内部电子邮件数据是了解该公司的重要数据源，它不但能反 映公司员工间及与业务对象间的复杂通信网络，还可以从邮件内容与附件中了解公司经营的业务内容。我们希望通过可视分析的方式解密 Hacking Team 公司的组织结构和发展历程。

  <h2>Usage Introduction</h2>
  <p>时间筛选：0-24为所有往来邮件在一天24小时中的分布情况，0-7为所有往来邮件在一星期七天中的分布情况（0为星期天，1为星期一，依次类推），第三根轴是从发出第一封邮件起到收到最后一封邮件为止的时间内邮件随时间的分布情况。时间筛选可叠加。颜色编码收／发邮件。
  <p>关系图：圆环角度编码在所筛选条件下某人发出邮件的数目，发的越多，所占角度越大。圆环可选中，进行进一步查看。（单击选中圆环可取消选择，单击chord中心取消选中）选中两人可查看两人之间邮件往来情况。每一条带编码两个人之间的邮件往来，条带两头的粗细编码那个人给另一个人所发的邮件数目。鼠标悬浮可见详细信息。
  <p>云图：所筛选情况下的邮件的主题编码成云图，字的大小越大代表出现数目越多，即越重要。

  <h2>What we found through visual analytics</h2>

  <p>比如，最直观的我们能发现：1.早上8点到下午15点，与常理不符的，往来邮件数目非常少；相反，晚上16点到23点则是邮件往来的高峰期。2.星期二到星期四邮件往来数目处于低谷，相反，周末则处于高峰期。3.从整体时间轴看，公司发展成良好的态势，然而2014年四月到七月则处于一个较明显的低谷，为什么呢？4.公司里几个比较重要的人员，邮件往来数目较多的有support(?), s.gallucci, m.bettini, i.rana, d.vincenzetti, d.milan, a.vincenzettie；次多的有m.valleri, m.luppi, g.russo, f.busatto, e.shehata。
  <p>2014.4-2014.7发生了什么？
  <p>d.milan的往来邮件数为何在2013.9发生激增？升职了吗？（且发件数一直较小于收件数）
  <p>白天邮件主要有关于什么，晚上往来邮件主要关于什么？
  <p>公司刚起步的时候邮件主要关于什么，到15年又转向了什么？
  <p>2013年初，公司刚起步的时候，公司职员较少，主要有d.milan, s.woon, a.scarafile, d.maglietta。d.milan与a.scarafile往来比较密切，d.maglietta与s.woon往来较为密切。而他们也随着公司的发展一路高升，并且始终保持紧密联系。大多数人都随着公司的发展在2014.8月9月左右的时候邮件数激增。公司到2015年中旬的时候，公司内职责分布较为平均，相对来说职责较重的有d.vincenzetti, i.rana, e.shehata和s.gallucci。s.gallucci和d.vincenzetti应该都是在2013年九月左右任职，并且都在一开始就受到了重任。且两个人(还有i.rana, e.shehata)都是发件数较大于收件数，是否从事类似相关工作？
  <p>整个公司的人的作息都很有意思。基本上大家都喜欢在下午、晚上的时候工作。若我们选中六点到十三点这个时间，可以发现在这个时间段中d.vincenzetti所发的邮件数是远远大于其他人的，s.woon和d.maglietta在这个时间段发的邮件数比例也是比较大的，且往来分布较均匀。d.vincenzetti早上两点到十点为一般休息时间，除了这个时间段外基本都在认真工作。而d.milan甚至会工作到早上五点（休息时间为6点到15点）。d.maglietta通过邮件很清楚的展示了他一天的作息，从八点到晚上五六点邮件往来数稳步上升，下午一点基本上是公司的吃饭时间（因为来的邮件数较少）。

  <!-- <p>Some questions to consider: How does time-of-day correlate with <a href="javascript:filter([null, [100, 150], null, null])">arrival delay</a>? Are <a href="javascript:filter([null, null, [1700, 2000], null])">longer</a> or <a href="javascript:filter([null, null, [0, 300], null])">shorter</a> flights more likely to arrive early? What happened on <a href="javascript:filter([null, [80, 150], null, [new Date(2001, 0, 12), new Date(2001, 0, 13)]])">January 12</a>? How do flight patterns differ between <a href="javascript:filter([null, null, null, [new Date(2001, 0, 27), new Date(2001, 0, 29)]])">weekends</a> and <a href="javascript:filter([null, null, null, [new Date(2001, 0, 29), new Date(2001, 1, 3)]])">weekdays</a>, or <a href="javascript:filter([[4, 7], null, null, null])">mornings</a> and <a href="javascript:filter([[21, 24], null, null, null])">nights</a>? <a href="https://github.com/square/crossfilter/tree/gh-pages">Fork this example</a> and try your own data! -->


</div>

<a href="https://github.com/realwsq/Inside-Hacking-Team"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

<!-- <footer>
  <span style="float:right;">
    Released under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.
  </span>
  Copyright 2012 <a href="http://squareup.com">Square, Inc.</a>
</footer> -->

<script src="../libs/d3.v3.min.js"></script>
<script src="vip_names.js"></script>
<script src="../libs/crossfilter-gh-pages/crossfilter.v1.min.js"></script>
<script src="../libs/d3-chord-diagrams-master/lib/underscore.js"></script>
<script src="../libs/d3-chord-diagrams-master/lib/mapper.js"></script>
<script src="websiteHelper.js"></script>
<script src="barChart.js"></script>
<script src="TimeSelection.js"></script>
<script src="wrapper.js"></script>
<script src="chordChart.js"></script>
<script src="../libs/d3-cloud-master/build/d3.layout.cloud.js"></script>
<script src="wordleChart.js"></script>
<link rel="stylesheet" type="text/css" href="index.css">

<script>

// timeline
// http://visjs.org/timeline_examples.html

// "": "774506"
// attachment names: ""
// creator name: "Daniel Maglietta"
// data received time: "2013/5/23 18:01:47"
// data sent time: "2013/5/23 18:01:46"
// from address: "d.maglietta"
// importance: "1"
// index: 0
// size: "49090"
// subject: "RE: FW: Our meeting"
// to address: "aikhong.ang@ip-tribe.com"
// to type: "cc"

// d3.csv("../data/cleaned_address.csv", function(error, flights) {
//   console.log(flights)
  
// })

// (It's CSV, but GitHub Pages only gzip's JSON at the moment.)
d3.csv("../data/sampled_data.csv", function(error, flights) {
  // Various formatters.
  var formatNumber = d3.format(",d"),
      formatChange = d3.format("+,d"),
      formatDate = d3.time.format("%B %d, %Y"),
      formatTime = d3.time.format("%I:%M %p");

  // A nest operator, for grouping the flight list.
  var nestByDate = d3.nest()
      .key(function(d) { 
        return formatDate(d.time); 
      });

  // 274734
  console.log(vip_names);
  //--------
  // flights = flights.slice(0,200)
  //--------
  flights = flights.filter(function(d) {
    // console.log(d)
    if (vip_names.indexOf(d["from address"]) !== -1 && 
      vip_names.indexOf(d["to address"]) !== -1) return true;
    else return false;
  })
  // 101519
  // A little coercion, since the CSV is untyped.
  flights.forEach(function(d, i) {
    d.index = i;
    d.time = parseDate(d["data sent time"]);
    d.yearAndMonth = d3.time.month(d.time);
    // d.yearAndMonth = (d.time.getYear()).toString()+"-"+(d.time.getMonth()).toString();
    d.weekday = d.time.getDay(); // 0-Sun 1-Mon 
    d.hour = d.time.getHours();
    // d.from_i = vip_names.indexOf(d["from address"]);  // d["from address"] contains name string
    // d.to_i = vip_names.indexOf(d["to address"]);   // d["to address"] contains name string
    // d.totype = d["to type"];
    // d.importance = d["importance"];
  });
  // console.log(flights)
    // "": "1149216"
    // attachment names: ""
    // creator name: "Marco Losito"
    // data received time: "2014/11/5 20:12:26"
    // data sent time: "2014/11/5 20:12:20"
    // from address: "a.capaldo"
    // hour: 20
    // importance: "1"
    // index: 0
    // size: "22987"
    // subject: "Condizioni bagno (area break)"
    // time: Fri Dec 05 2014 20:12:00 GMT+0800 (CST) {}
    // to address: "d.giubertoni"
    // to type: "direct"
    // weekday: 5
    // yearAndMonth: Mon Dec 01 2014 00:00:00 GMT+0800 (CST)

  var selectedEmailAccount = [];
  // check if v[attr] in array
  var checkIfInSelected = function(v, attr, array) {
    // console.log(v,attr,array)
    if (array.length == 0) return true;
    if (array.indexOf(v[attr]) > -1) {
      // console.log(selectedEmailAccount, attr);
      return true;
    }
    else return false;
  }
  function selectedEmailAccountFilter(d) {
    switch (selectedEmailAccount.length) {
      case 0: return true;
      case 1: 
        for (var i = 0; i < d.length; i++) {
          if (selectedEmailAccount[0] == d[i]) return true;
        }
        return false;
      default:
        // 这里知道了d只有两项，收件人和寄件人 
        // 不关心自己寄给自己的
        if (d[0] == d[1]) return false;
        if (selectedEmailAccount.indexOf(d[0]) == -1) return false;
        if (selectedEmailAccount.indexOf(d[1]) == -1) return false;
        return true;
    }
  }

  // Create the crossfilter for the relevant dimensions and groups.
  var flight = crossfilter(flights),
      all = flight.groupAll(),
      from_to_wrapper = wrapper(["from address", "to address"], [])
      from_to = flight.dimension(function(d) { return from_to_wrapper.jsonify(d);}),
      from_tos = from_to.group()


  var chrodChartInstance = chrodChart()
      // .dimension(from_to)
      .group(from_tos)
      .filter(selectedEmailAccountFilter)
      .notifyOutside(function(selected) {
        console.log("set outside selected account", selected);
        selectedEmailAccount = selected;

        from_to.filter(function(d) {
          // return d.startsWith(name)||d.endsWith(name)
          return selectedEmailAccountFilter(from_to_wrapper.getValue(d))
        })
        renderAll();
      })
      .wrapper(from_to_wrapper);
      // .round(Math.floor)

  var wordleChartInstance = wordleChart()
    .dimension(from_to);

  // Render the initial lists.
  // var list = d3.selectAll(".list")
  //     .data([flightList]);

  // Render the initial chrod.
  var chrod = d3.selectAll(".chrod")
      .data([chrodChartInstance])
      // .each(function(chart) { chart.on("brush", renderAll).on("brushend", renderAll); });

  var wordle = d3.selectAll(".wordle")
      .data([wordleChartInstance])

  var timeSelection = TimeSelection()
        .crossfilter(flight)
        .accessTime({
          getHour: function(d) {return d.hour;},
          getWeekday: function(d) {return d.weekday;},
          getMonth: function(d) { return d.yearAndMonth; },
          domain: [new Date(2012, 0, 1), new Date(2015, 12, 31)],
          howManyMonthsInDomain: 4*12
        })
        .stackData({
          group: function(gtime, d, g) {
            if (!(gtime in g)) {
              g[gtime] = {"sent": 0, "received": 0};
            }
            if (checkIfInSelected(d, "from address", selectedEmailAccount)) g[gtime].sent++;
            if (checkIfInSelected(d, "to address", selectedEmailAccount)) g[gtime].received++;
            return g;
          },
          stackedKey: ["sent", "received"]
        })
        .barWidth(10)
        .DOMclass("chart")
        .notifyOutside(renderAll)

  timeSelection.start();


  // Render the total.
  d3.selectAll("#total")
      .text(formatNumber(flight.size()));
  renderAll();

  // Renders the specified chart or list.
  function render(method) {
    d3.select(this).call(method);
  }

  // Whenever the brush moves, re-rendering everything.
  function renderAll() {
    console.log("in render all")
    timeSelection.draw();
    // list.each(render);
    chrod.each(render);
    wordle.each(render);
    d3.select("#active").text(formatNumber(all.value()));
  }

  // Like d3.time.format, but faster.
  function parseDate(d) {
    var _ = d.split(" ")
    var date = _[0].split("/");
    var time = _[1].split(":");
    return new Date(
        date[0],
        date[1],
        date[2],
        time[0],
        time[1]);
  }

  window.filter = function(filters) {
    console.log("window.filter")
    filters.forEach(function(d, i) { charts[i].filter(d); });
    renderAll();
  };

  window.reset = function(i) {
    console.log("window.reset")
    charts[i].filter(null);
    if (i == -1) {
      chrod.clearfilter();
    }
    renderAll();
  };

  function flightList(div) {
    var flightsByDate = nestByDate.entries(from_to.top(40));
    div.each(function() {
      var date = d3.select(this).selectAll(".date")
          .data(flightsByDate, function(d) { return d.key; });

      date.enter().append("div")
          .attr("class", "date")
        .append("div")
          .attr("class", "day")
          .text(function(d) { return d.key; });

      date.exit().remove();

      var flight = date.order().selectAll(".flight")
          .data(function(d) { return d.values; }, function(d) { return d.index; });

      var flightEnter = flight.enter().append("div")
          .attr("class", "flight");

      flightEnter.append("div")
          .attr("class", "time")
          .text(function(d) { return formatTime(d.time); });

      flightEnter.append("div")
          .attr("class", "origin")
          .text(function(d) { return d["from address"]; });

      flightEnter.append("div")
          .attr("class", "destination")
          .text(function(d) { return d["to address"]; });

      flightEnter.append("div")
          .attr("class", "distance")
          .text(function(d) { return d["subject"]; });

      flightEnter.append("div")
          .attr("class", "delay")
          .text(function(d) { return d["importance"]; });

      flight.exit().remove();

      flight.order();
    });
  }

  
});








</script>
